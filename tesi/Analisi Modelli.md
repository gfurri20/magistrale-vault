## **27 ottobre 2025**

Ho iniziato i test base su due modelli:
- `meta-llama/llama-3.3-8b-instruct:free` molto approssimativo e impreciso
- `alibaba/tongyi-deepresearch-30b-a3b:free` spesso risposte che si avvicinano a quelle corrette, da approfondire. Pochissimi token di input a disposizione.

Ho creato un notebook jupyter con del codice iniziale, senza filtri applicati al dataset.

Devo capire come "dialogare" in streaming con il modello in modo da interagire dinamicamente con le domande.

---

## **28 ottobre 2025**

Risulta interessante capire come mantenere un contesto per avanzare nel porre domande.
Ciò che devo capire è come mantenerlo: qual è il metodo migliore e come implementarlo nel codice.
Per fare ciò, attualmente, ho adottato un sistema che utilizza una variabile `contex`. Questa variabile mantiene le risposte ad ogni domanda e viene riproposta come contesto prima della domanda successiva.
In questo modo il modello è a conoscenza delle sue risposte precedenti.

Purtroppo LLAMA non risulta essere troppo efficace, nemmeno conoscendo il nome dei registri.

C'è da migliorare le domande e cominciare a salvarsi un po' di risultati per analizzare meglio.

---

## **29 ottobre 2025**

```python
base_prompt = """You are an expert in industrial control systems and in understanding the system architecture by looking at the register values.
In the following, I'll provide you with a list of register values collected over time.

Data:
- This is the scan obtained by observing, for a certain period of time, the contents of the registers of 3 PLCs of an industrial system.
- The first line contains headers that you can use to refer to each register in your answer.

Task:
- The goal is to analyze these values and identify any relationships between columns values.
- Respond clearly with an answer that can be evaluated — in this case, Yes, No or a Number.
"""

q1 = "Q1: Are you able to understand at what type of phisical industrial control system these data refers to?"
q2 = "Q2: Assuming that the industrial system is a water filtration system that certainly uses tanks, are you able to understand how many tanks are involved in the system?"
q3 = "Q3: Are you able to associate the 3 PLCs with the tanks you think you have identified?"
q4 = "Q4: In reality, there are three tanks. Are you able to identify which PLC registers are dedicated to measurements and which to actuations, for each tank?"
q5 = "Q5: In fact, there are three tanks. Are you able to identify which PLC registers are dedicated to measurements and which to actuations, for each tank?"
q6 = "Q6: In fact, there are three tanks. Are you able to identify if there are PLC registers used to store other significant information, such as setpoints or other parameters?"
q7 = "Q7: Considering that there are three tanks, are you able to deduce whether there is a physical connection, i.e., pipes, linking two or more tanks? (This is information that, in our paper, we are not able to derive)"
q8 = "Q8: Assuming you have identified the registers dedicated to containing measurements and actuations for each tank, are you able to construct, for each tank, a chart showing how these quantities, measurements and actuations, evolve over time?"
q9 = "Q9: Are you able to construct a chart representing the operation of the entire system over time?"
q10 = "Q10: For each tank, are you able to extract invariants that relate measurements with actuations?"
q11 = "Q11: Are you able to extract significant invariants that connect the register contents of the entire industrial system?"
```

Oggi ho svolto diverse prove, impostando alcuni parametri differenti.

### **Test 1**
- `baseline.csv` senza compressione
- `meta-llama/llama-3.3-8b-instruct:free`
- header del dataset non Anonimizzato (quindi con i nomi dei registri)
- prime `2000` righe di dataset in analisi
- contesto progressivo nelle chiamate

| Domanda | Commento                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| ------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Q1`    | Non individua di preciso la tipologia di sistema, afferma che si tratta di un sistema Modbus o OPC UA                                                                                                                                                                                                                                                                                                                                                                                         |
| `Q2`    | Non stima il numero di tanks                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `Q3`    | Individua 8 tanks: PLC1 (gestisce 1, 2 e 3), PLC2 (gestisce 4 e 5), PLC1 (gestisce 6, 7 e 8). Questa è completamente inventata                                                                                                                                                                                                                                                                                                                                                                |
| `Q4`    | Dandogli il numero di tanks associa PLC1 a Tank1, PLC2 a Tank2 e PLC3 a Tank3, e leggendo il nome del registro capisce la tipologia                                                                                                                                                                                                                                                                                                                                                           |
| `Q5`    | Leggendo il nome del registro capisce la tipologia e il suo presunto contenuto (tra misurazione ed attuazione)                                                                                                                                                                                                                                                                                                                                                                                |
| `Q6`    | Individua i registri $MWx$ come contenitori di setpoints o altri parametri                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `Q7`    | Non è in grado                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| `Q8`    | $IWx$ stabili attorno a 10, con alcune fluttuazioni<br>$MWx$ aumentano nel tempo con alcuni drop occasionali<br>$QXxx$ stazionari o cambiano leggermente                                                                                                                                                                                                                                                                                                                                      |
| `Q9`    | Riporta una tabella temporale dei dati                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `Q10`   | Non è in grado                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| `Q11`   | Trova delle relazioni ma niente di più tra registri sulla base del fatto che i loro valori cambiano insieme<br>- `PLC1_InputRegisters_IW0` and `PLC2_InputRegisters_IW0`<br>- `PLC1_MemoryRegisters_MW0` and `PLC2_MemoryRegisters_MW0`<br>- `PLC3_Coils_QX00` connected to the `PLC1_Coils_QX00` and `PLC2_Coils_QX00`<br>- `PLC1_MemoryRegisters_MW1` and `PLC3_MemoryRegisters_MW1`<br>- `PLC2_MemoryRegisters_MW1` connected to `PLC1_MemoryRegisters_MW1` and `PLC3_MemoryRegisters_MW1` |


---

## **4 novembre 2025**

### **Test 1**
- `baseline.csv` senza compressione
- `qwen/qwen3-235b-a22b:free`
- header del dataset non Anonimizzato (quindi con i nomi dei registri)
- prime `100` righe di dataset in analisi
- contesto progressivo nelle chiamate

Qua c'è un bel problema: con solo 100 righe di database il registro che mantiene il livello di Tank3 non viene aggiornato e rimane costante ad 1. Questo causa un errore nell'analisi del modello perché non permette la visualizzazione del trend di crescita e decrescita.

| Domanda | Commento                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| ------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Q1`    | "Yes", nessuna specifica in più                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| `Q2`    | `PLC1_InputRegisters_IW0` decreases from 81 to 56 while `PLC2_InputRegisters_IW0` increases from 10 to 19.<br>two-tank system where water is transferred from one tank (PLC1) to another (PLC2).<br>**2 tanks** are involved.<br>Stima il numero di tank analizzando l'andamento dei dati nei registri. Inoltre ipotizza uno scambio di liquido tra un tank ed un altro.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `Q3`    | Associa PLC1 e PLC2 a due tank mentre PLC3 (presa in esame rispetto al registro `PLC3_Coils_QX00`) viene definita come una PLC che controlla la logica senza essere associata a nessun tank.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| `Q4`    | - `PLC1_InputRegisters_IW0` decreases steadily from 81 → 56 (Tank 1 level dropping)<br>- `PLC2_InputRegisters_IW0` increases steadily from 10 → 19 (Tank 2 level rising)<br>- `PLC3_InputRegisters_IW0` remains constant at 1 (Tank 3 status/level fixed)<br>- Transfer begins when `PLC1_Coils_QX01` and `PLC1_Coils_QX02` switch from 0 → 1<br>Inoltre, il modello cerca di assegnare un ruolo ad ogni tank:<br>- Tank 1 (source tank)<br>- Tank 2 (destination tank)<br>- Tank 3 (static/auxiliary tank)<br>Infine, identifica i registri `MW` come dei contenitori di tresholds                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| `Q5`    | 1. **Tank 1 (Source Tank):**<br>   - **Measurement:** `PLC1_InputRegisters_IW0` (shows decreasing levels: 81 → 56)<br>   - **Actuation:** `PLC1_Coils_QX01`, `PLC1_Coils_QX02` (toggle from 0 → 1 to initiate liquid transfer)<br>   - **Setpoints/Memory:** `PLC1_MemoryRegisters_MW0=40` (lower threshold), `PLC1_MemoryRegisters_MW1=80` (upper threshold)<br><br>2. **Tank 2 (Destination Tank):**<br>   - **Measurement:** `PLC2_InputRegisters_IW0` (shows increasing levels: 10 → 19)<br>   - **Actuation:** `PLC2_Coils_QX00` (remains active at 1 for inflow control)<br>   - **Setpoints/Memory:** `PLC2_MemoryRegisters_MW0=10` (target level), `PLC2_MemoryRegisters_MW1=20` (maximum capacity?)<br><br>3. **Tank 3 (Static/Auxiliary Tank):**<br>   - **Measurement:** `PLC3_InputRegisters_IW0` (fixed value of 1, likely status flag or overflow indicator)<br>   - **Actuation:** `PLC3_Coils_QX00` (remains inactive, possibly controls overflow valve or heater)<br>   - **Setpoints/Memory:** `PLC3_MemoryRegisters_MW1=10` (unclear context, potential temperature or pressure target?) |
| `Q6`    | 1. **Setpoints (fixed thresholds):**<br>   - `PLC1_MemoryRegisters_MW0=40`: Lower level threshold for Tank 1 (triggers low-level alarm)<br>   - `PLC1_MemoryRegisters_MW1=80`: Upper level limit for Tank 1 (matches when transfer initiates after level drops below 80)<br>   - `PLC2_MemoryRegisters_MW0=10`: Target minimum level for Tank 2 (matches initial level)<br>   - `PLC2_MemoryRegisters_MW1=20`: Maximum capacity for Tank 2 (transfer stops near 19)<br>   - `PLC3_MemoryRegisters_MW1=10`: Auxiliary parameter for Tank 3 (likely overflow threshold)<br><br>2. **Process Parameters:**<br>   - `PLC1_Coils_QX01` & `PLC1_Coils_QX02=1`: Enable transfer valves (activated simultaneously to start flow)<br>   - `PLC2_Coils_QX00=1`: Always-active inflow valve for Tank 2<br>   - `PLC3_InputRegisters_IW0=1`: Constant status flag for Tank 3 (no level change observed)<br><br>3. **Diagnostics:**<br>   - `prev_PLC*_` registers track delta values for anomaly detection (e.g., rapid level changes)<br><br>Interessante come cerca di dare una spiegazione anche i registri `prev_`  |
| `Q7`    | Non in grado, anche se in realtà individua uno scambio tra Tank1 e Tank2. Tutto il ragionamento sfuma perché la domanda chiede tra i TRE tank. A causa dei dati imprecisi il modello non si convince di connessioni per Tank3.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| `Q8`    | Afferma che si potrebbero rappresentare i dati con un andamento lineare                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| `Q9`    | Crashato                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `Q10`   | Crashato                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `Q11`   | Crashato                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |

Qwen sembra dimostrarsi un buon modello d'analisi e dovrebbe essere approfondito maggiormente con configurazioni diverse.


---

## **8 novembre 2025**
### **Test 1**
Innanzitutto ho modificato leggermente il testo "developer" di setting del modello:
```
Within the full response attach an evaluable response — in this case, Yes, No or a Number.
```

- `baseline.csv` con compressione, nello specifico
	- `Deduplication: reduced size from 30059 to 10279`
	- `Remove one every 2: reduced size from 10279 to 5140`
- modello di openrouter `openrouter/polaris-alpha`
- header del dataset non Anonimizzato (quindi con i nomi dei registri)
- prime `5000` righe di dataset in analisi
- contesto progressivo nelle chiamate

| Domanda | Commento                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| ------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Q1`    | **NO** - identifica il numero corretto di PLC (3) e individua dei trend nei dati in analisi:<br>pattern a triangolo/rampa ripetitivi, commutazioni a soglia fissa, diverse PLC che condividono patterns correlati; inoltre fa riferimento al fenomeno di isteresi.<br>Afferma che non c'è un'impronta digitale e che quindi non è possibile affermarlo con certezza, tra gli esempi parla di tank e trasferimenti d'acqua.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `Q2`    | **SI, 3** - individua tre registri `IWx` (associati a 3 PLC diverse) che oscillano tra specifici intervalli. Inoltre, per ognuno di essi altri registri fungono da threshold ed attuatori `MWx` e `QXx`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `Q3`    | **SI** - senza ulteriori specifiche                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `Q4`    | **SI** - molto semplicemente per le tre tanks: `IWx` misure e `MWx`/`QXxy` attuatori                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `Q5`    | **SI** - molto semplicemente per le tre tanks: `IWx` misure e `MWx`/`QXxy` attuatori                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `Q6`    | **SI** - individua i registri threshold per PLC1 e PLC2, insieme agli effettivi valori.<br>MW0/MW1 are Tank 1,2 level thresholds / setpoints controlling its fill/empty logic or transfer conditions.<br>Per Tank 3 identifica MW1 come threshold e IW0 come "segment/count"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `Q7`    | **SI** - afferma di non riuscire ad individuare la geometria precisa ma, con un buon livello di confidenza, inferisce che i tre tank NON sono indipendenti. Dovrebbero essere idraulicamente connessi.<br>- “Tank1 outflow becomes Tank2 inflow,”<br>- "PLC3’s increments/decrements align with PLC2’s fill/empty decisions, suggesting Tank3 receives what Tank2 sends"<br>- "cascaded tanks (Tank1→Tank2→Tank3) or a recirculating manifold"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| `Q8`    | Non eseguite                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `Q9`    | Non eseguite                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| `Q10`   | **SI**<br><br>Key invariants by “tank” (concise, directly based on the given registers):<br><br>Tank 1 (PLC1: IW0, MW0=40, MW1=80, QX00/01/02):<br>- Level band:<br>  - PLC1_IW0 always constrained ≈ [40, 80].<br>- Threshold invariants:<br>  - MW0 and MW1 are constant and act as low/high thresholds.<br>  - When IW0 ≤ 40, PLC1_Coils_QX00 (fill/enable) is (eventually) set = 1.<br>  - When IW0 ≥ 80, PLC1_Coils_QX00 is (eventually) reset = 0.<br>- Actuation patterns:<br>  - QX01 and QX02 change only when IW0 is inside the 40–80 band and follow fixed, repeatable patterns (staged outputs/interlocks).<br>  - No samples violate: (IW0 < 40 or IW0 > 80) while the memory thresholds remain unchanged (MW0=40, MW1=80).<br><br>Tank 2 (PLC2: IW0, MW0=10, MW1=20, QX00):<br>- Level band:<br>  - PLC2_IW0 constrained ≈ [10, 20].<br>- Threshold invariants:<br>  - MW0=10, MW1=20 act as low/high limits.<br>  - If IW0 ≤ 10, PLC2_Coils_QX00 (inlet/enable) tends to 1; if IW0 ≥ 20, QX00 tends to 0.<br>- Actuation pattern:<br>  - QX00 only switches at or near these invariant boundaries; no stable behavior outside that band.<br><br>Tank 3 (PLC3: IW0, MW1=80, QX00):<br>- Level/segment behavior:<br>  - PLC3_IW0 is a small integer (0,1,2,3,…) that:<br>    - Increments when PLC1/2 outputs indicate transfer,<br>    - Decrements/reset as sequences complete.<br>- Invariants:<br>  - PLC3_MW1 fixed at 80; used as reference (e.g., max capacity/upper bound) and not violated.<br>  - PLC3_Coils_QX00:<br>    - Goes to 1 only under specific combined conditions:<br>      - PLC3_IW0 > 0 (or ≥ defined step),<br>      - Upstream tank(s) in valid range (PLC1/2 within [40,80]/[10,20]),<br>      - No conflicting downstream/interlock bits.<br>    - Returns to 0 when those enabling conditions are not satisfied.<br>  - No instances where QX00=1 contradicts these level/interlock conditions.<br><br>Cross-tank coupling (shared invariants):<br>- Hierarchical ranges:<br>  - Tank1: 40–80<br>  - Tank2: 10–20<br>  - Tank3: discrete counts tied to transfers.<br>- Transfer logic:<br>  - Changes in a downstream tank’s IW0 occur only when upstream QX (pump/valve) is active and its IW0 is inside its allowed band.<br>  - You never see:<br>    - A downstream fill actuation (QX00=1) while the upstream tank is below its low threshold or above its high threshold.<br>    - A level outside its tank’s configured band without corresponding disabling of its fill/transfer coil.<br><br>So, yes: for each tank, the dataset reveals stable invariants linking:<br>- fixed memory thresholds (MW*),<br>- admissible measurement ranges (IW0),<br>- and the enable/disable states and sequence of the coils (QX*). |
| `Q11`   | **SI**<br><br>Key invariants connecting the whole system (concise):<br><br>1) Fixed analog bands and shared limits:<br>- PLC1_InputRegisters_IW0 always stays within [40, 80].<br>- PLC2_InputRegisters_IW0 always stays within [10, 20].<br>- PLC3_InputRegisters_IW0 is a small integer/counter with constrained patterns (0–~10, then bounded).<br>- PLC1_MemoryRegisters_MW0 = 40, PLC1_MemoryRegisters_MW1 = 80.<br>- PLC2_MemoryRegisters_MW0 = 10, PLC2_MemoryRegisters_MW1 = 20.<br>- PLC3_MemoryRegisters_MW1 = 80.<br>These constants define global hysteresis/setpoint bands; no trace violates them.<br><br>2) Deterministic coil logic from analog values:<br>- PLC1_Coils_QX00 (and similarly QX01/QX02) is fully determined by PLC1_IW0 vs MW0/MW1:<br>  - IW0 ≤ 40 → QX00 turns ON (start/fill/enable).<br>  - IW0 ≥ 80 → QX00 turns OFF (stop/disable).<br>- PLC2_Coils_QX00 is fully determined by PLC2_IW0 vs 10/20:<br>  - IW0 ≤ 10 → QX00 ON.<br>  - IW0 ≥ 20 → QX00 OFF.<br>- PLC3_Coils_QX00 = 1 only inside narrow, consistent state windows tied to:<br>  - PLC3_IW0 > 0,<br>  - upstream tanks within their valid bands,<br>  - and previous-state coherence (no contradictory edges).<br>Across the log there are no stable exceptions: coils never remain in a state contradicting their analog thresholds plus hysteresis.<br><br>3) Time-consistent cascade behavior:<br>- When PLC1_QX00 indicates “sending” (or equivalent), PLC1_IW0 decreases and, with a fixed lag, PLC2_IW0 increases within its 10–20 band; when PLC2_QX00 disables, the relationship stops.<br>- Similar lagged, conditional relationships exist between PLC2 and PLC3 (via PLC3_IW0 and QX00).<br>- You never see:<br>  - A downstream “fill” condition active while the upstream level is outside its allowed band.<br>  - A downstream level change that is not preceded/justified by a valid upstream coil/level condition.<br>This defines system-wide invariants: transfers only occur under coherent upstream/downstream constraints.<br><br>4) Cross-sample consistency (prev_* fields):<br>- The prev_* columns confirm:<br>  - Monotonic or stepwise-consistent changes.<br>  - No impossible jumps (e.g., coil toggling without corresponding analog condition nearby).<br>- Every transition of a current variable aligns with its previous value and the associated logic, across all PLCs.<br><br>5) Structural invariants:<br>- Global separation of roles:<br>  - IW* = process measurements,<br>  - MW* = static configuration (thresholds),<br>  - QX* = boolean actions derived from IW*/MW* with hysteresis,<br>  - prev_* = temporal consistency check.<br>- No register ever behaves inconsistently with its inferred role across the dataset. |

Il modello sembra individuare bene le proprietà descritte anche nel paper di Ceccato et al.
Non so per quale motivo segna a PLC3_MW1 un valore costante di 80 nonostante sia 10.

Non riesce ad individuare la correlazione tra spegnimento di `PLC1_QX00` e l'accensione di `PLC1_QX01 == PLC1_QX02 == PLC2_QX00`, trend che stabilisce la fine del riempimento di Tank1, l'inizio dello svuotamento della stessa e il riempimento di Tank2.

Altra cosa interessante da capire sarebbe il come mai il livello di Tank1 registra, durante lo svuotamento, alcuni momenti di fermo.

---

## **18 novembre 2025**

Configurazione:
- `baseline.csv` con compressione, nello specifico
	- `Deduplication: reduced size from 30059 to 10279`
	- `Remove one every 2: reduced size from 10279 to 5140`
- modello di openrouter `openrouter/sherlock-think-alpha`
- header del dataset non Anonimizzato (quindi con i nomi dei registri)
- tutte le righe del dataset compresso


Testo in input:
```
# Context
You are an expert in Industrial Control Systems (ICS).
Your expertise is in understanding system architecture by analyzing the time-series values of its registers.
An ICS system is secured using invariants: these are properties or relationships that must always remain constant to ensure the system's correct and safe operation.
Present your findings in a clear, structured format.

---

# ICS in analysis
The system being analyzed has 3 PLCs. Each PLC controls 3 water tanks (and their related components):
- PLC1 controls T-201 
- PLC2 controls T-202
- PLC3 controls T-203
The system's purpose is water purification (creating potable water) via a chemical process.

---

# Data
The analysis dataset is a time-series scan of the system's register states.
The plaintext dataset is in CSV format:
* The first row is the header (column names).
* All data is comma-separated.
* Data values in subsequent rows correspond to the header columns by their position (index).

---

# Task
Your objectives are:
1. Register Classification: Analyze the data and classify the registers by their functional type for every PLC.
2. Invariant Extraction: Identify and extract significant invariants from the data. These invariants are the critical relationships that define the system's normal behavior.
   Goal: These invariants will be used to monitor the system, secure it, and verify that its normal operational flow is not compromised at any time.
3. Try to demonstrate the invariants you found with examples from the data provided.
4. Try to demonstrate this property: "When PLC1_Coils_QX00 changes its state from 0 to 1, it activates an ascending trend in T-201."
"""
```


Cataloga bene i vari registri ed individua i trend di crescita e decrescita in abse allo stato dei Coils.

Individua alcune proprietà semplici, senza approfondirle.

|Invariant|Description|
|---|---|
|If `PLC1_Coils_QX00==1 ∧ PLC1_Coils_QX01==0 ∧ PLC1_Coils_QX02==0` then `PLC1_InputRegisters_IW0 > prev_PLC1_InputRegisters_IW0`|Filling mode → level **increases**.|
|If `PLC1_Coils_QX00==0 ∧ PLC1_Coils_QX01==1 ∧ PLC1_Coils_QX02==1` then `PLC1_InputRegisters_IW0 < prev_PLC1_InputRegisters_IW0` (or equal)|Draining mode → level **decreases/stabilizes**.|
|If `PLC2_Coils_QX00==1` then `PLC2_InputRegisters_IW0 >= prev_PLC2_InputRegisters_IW0`|Filling → non-decreasing.|
|If `PLC2_Coils_QX00==0` then `PLC2_InputRegisters_IW0 <= prev_PLC2_InputRegisters_IW0`|Draining → non-increasing.|
|`PLC1_Coils_QX00==1 ∧ PLC1_Coils_QX01==0 ∧ PLC1_Coils_QX02==0` IFF `PLC2_Coils_QX00==0`|**Inter-PLC**: T-201 fills ↔ T-202 drains (water transfer). Reverse holds during drain/fill swap.|

L'ultima riga individua un'invariante Inter-PLC, in cui viene quasi individuato il canale di comunicazione sia tra PLC, che fisico con i tubi di trasferimento dell'acqua.

1. **Setpoint Constants**:
    - `PLC1_MemoryRegisters_MW0 == 40`
    - `PLC1_MemoryRegisters_MW1 == 80`
    - `PLC2_MemoryRegisters_MW0 == 10`
    - `PLC2_MemoryRegisters_MW1 == 20`
    - `PLC3_MemoryRegisters_MW1 == 10`
2. **Coil Synchronization**:
    - `PLC1_Coils_QX01 == PLC1_Coils_QX02` (drain valves always match)
3. **Mutual Exclusion (No Simultaneous Fill/Drain)**:
    - `PLC1_Coils_QX00 * (PLC1_Coils_QX01 OR PLC1_Coils_QX02) == 0` (fill and drain never active together)
4. **PLC3 Idle**:
    - `PLC3_Coils_QX00 == 0`
5. **PLC3 Normal Range**:
    - `PLC3_InputRegisters_IW0 IN {1, 2}`
6. **Trend Correlations** (using prev/current for delta):
    - If `PLC1_Coils_QX00 == 1 AND prev_PLC1_Coils_QX00 == 0`, then `PLC1_InputRegisters_IW0 <= 53` AND next level > current (ascending starts)
    - If `PLC1_Coils_QX01 == 1 AND prev_PLC1_Coils_QX01 == 0`, then `PLC1_InputRegisters_IW0 >= 80` AND next level < current (descending starts)
    - Similar for PLC2: `PLC2_Coils_QX00 == 1` implies next `PLC2_InputRegisters_IW0 >= current` (fills 10→20)
7. **Inter-PLC Dependency (Purification Flow)**:
    - When `PLC1_Coils_QX01 == 1` (draining T-201), `PLC2_Coils_QX00 == 1` often (70% correlation; T-201 outflow feeds T-202 fill)
8. **Level Bounds**:
    - `40 <= PLC1_InputRegisters_IW0 <= 81`
    - `10 <= PLC2_InputRegisters_IW0 <= 20`
    - `PLC3_InputRegisters_IW0 <= 2` $\rightarrow$ Non identifica la vera soglia


Alcune considerazioni:
- **PLC3**
	- i dati in input non sono rappresentativi del comportamento di PLC3 in quanto valori ed invarianti estratte non sono corrette
- **Comunicazione PLC1 e PLC2**
	- sembra individuare un collegamento tra `PLC1_QX01`e `PLC1_QX02`, il primo è l'effettivo attuatore e prende il proprio valore dal secondo che è un registro utilizzato come output di comunicazione con PLC2
- T-201 outflow feeds T-202 fill
- **Non sa cos'è un'invariante**
	- non individua quelle configurazioni ILLEGALI che porterebbero a compromettere il sistema $\rightarrow$ non chiesto esplicitamente
	- individua, però, delle proprietà (ancora un po' lasche) del sistema


## 23 novembre 2025
Oggi si tenta di redirigere l'output in formato JSON, con l'obiettivo di ottenere un risultato standardizzato utile per essere analizzato.

```
You are an expert in Industrial Control Systems (ICS), specialized in identifying system architecture and component relationships by analyzing time-series values of PLC registers.

## Data Format
You will receive a raw plaintext dataset in CSV form:
- The first row contains column names (register labels).
- All fields are comma-separated.
- Each following row represents the register states at a specific timestamp.

## Task
Analyze the dataset and answer the following questions:
- Q1: Can you infer what type of physical industrial control system these data may refer to?
- Q2: Assuming the system is a water-filtration system with tanks, can you estimate how many tanks are involved?
- Q3: Can you associate the three PLCs with the tanks you identify?

## Output Requirements
Respond ONLY with a JSON object in this exact structure:

{
  "q1": {
    "answer": "",
    "confidence": 0.0,
    "reasoning": ""
  },
  "q2": {
    "answer": null,
    "confidence": 0.0,
    "identified_tanks": [],
    "reasoning": ""
  },
  "q3": {
    "answer": null,
    "confidence": 0.0,
    "mapping": {
      "PLC_1": null,
      "PLC_2": null,
      "PLC_3": null
    },
    "reasoning": ""
  },
  "limitations": [],
  "internal_checks": {
    "columns_used": [],
    "assumptions_detected": [],
    "warnings": []
  }
}

Fill every field; use null if uncertain.  
Do NOT add text outside the JSON.

## Data (CSV)
```

In questo formato il modello ottiene subito informazioni utili per rispondere alle domande.
Eseguo una domanda alla volta partendo da `Q1`.

