Appunti relativi all'analisi del malware d'esame.
Password per il file zippato: `infected`.
Analizzare solo il file che contiene la sotto-procedura: `sub_4020BE`, ovvero `b06ab1f3abf8262f32c3deab9d344d241e4203235043fe996cb499ed2fdf17c4` (113 KB).

# Analisi Statica
Analisi statica del file con PEStudio.

Alcune annotazioni iniziali:
- è un Windows Executable (primi due byte `MZ`) che possiede una GUI
- compilato nel maggio 2019 per CPU a 32 bit
- il nome originale è `dpserver.exe`
- probabilmente il malware si spaccia per un printer server per eseguire azioni malevoli
- la `virtual-size` della sezione `.data` (dati globali) è maggiore di circa $2300$ bytes rispetto alla `raw-size`, questo potrebbe indicare che vengano caricate informazioni aggiuntive durante l'esecuzione (tra l'altro `.data` è anche *writable*)
- l'eseguibile sembra addirittura essere possedere un certificato firmato digitalmente con scadenza nel 2039 (forse tanto nel futuro), il sito *Hybrid Analysis* dice che "Error validating certificate: A certificate chain could not be built to a trusted root authority. (0x800b010a)"

## Il malware è impacchettato?
Il malware **non sembra essere impacchettato**.
### Quale packer è stato utilizzato?
Nessuno.
### Quali sono gli elementi che indicano che il malware è impacchettato?
Di solito se un malware è impacchettato la `signature` del file fa riferimento al metodo di impacchettamento. In questo caso la `signature` corrisponde a `Microsoft Visual C++ 8` che caratterizza un qualsiasi Windows Executable legittimo.
Un altro modo per capire se il malware è impacchettato è quello di analizzare la differenza tra le `raw-size` e `virtual-size`.

## Quali API vengono importate dal malware?
Il malware importa inizialmente quattro `dll`:
- `kernel32.dll`
	- per importare librerie a runtime, e.g. `GetModuleHandleExW`, `LoadLibraryW`, `GetModuleFileNameA`
	- gestione di Thread e Processi, e.g. `CreateProcessW`, `GetCurrentProcessId`, `Sleep`, `GetCurrentProcess`
	- gestione di file, e.g. `WriteFile`, `DeleteFileW`, `SetFileAttributesw`, `GetFileType`, ...
	- `GetVolumeInformationW` per recuperare le informazioni sul file system
	- alcune API di codifica e decodifica, e.g. `WideCharToMultiByte`
	- gestione della console, e.g. `GetConsoleCP`, `WriteConsoleW`, `GetCommandLineW`
	- gestione della memoria dinamica (heap), e.g. `HeapFree`, `GetProcessHeap`, ...
	- gestione delle Exception, e.g. `RaiseException`
	- gestione del **TLS dei Thread**, e.g. `TlsAlloc`, `TlsFree`, `TlsGetValue`, `TlsSetValue`
	- API di verifica per **controllare la presenza di un debugger**, e.g. `IsDebuggerPresent`, `GetTickCount`, `GetStartupInfoW`
	- gestione della **sincronizzazione tra processi**, e.g. `CreateMutexW`, `SetEvent`, `OpenEventW`, `EnterCriticalSection`
- `user32.dll`
	- importa una `wsprintfW` che permette di scrivere una stringa formattata in un buffer
- `shlwapi.dll` - libreria che offre alcune funzionalità per la Shell
	- importa `PathFindFileNameW` che cerca un file all'interno di un percorso preso come argomento 
- `winhttp.dll` - libreria che espone un set di funzioni C/C++ che consentono all'applicazione di accedere alle risorse HTTP sul Web.
	- `WinHttpOpen` che inizializza, per un'applicazione, l'uso di funzioni `WinHTTP` e restituisce un handle di sessione `WinHTTP`
	- `WinHttpSendRequest` che invia la richiesta specificata al server HTTP relativo alla sessione `WinHTTP`
	- da documentazione per specificare l'indirizzo del server HTTP è necessario usare `WinHttpConnect`, *quindi a quale server si connette se questa API non si trova?*

### Qual è un possibile comportamento del malware in base alle API importate?
In base all'analisi delle API possiamo individuare alcuni *possibili* comportamenti del malware che agiscono insieme:
- cerca di inviare sulla rete richieste HTTP attraverso le API di rete, tra le stringhe sono presenti diversi riferimenti a parametri dell'header HTTP, e.g. `POST`, `GET`, `UserAgent`, ...
- cerca di creare e gestire processi e thread, probabilmente sincronizzandoli tra loro grazie alle API di sincronizzazione
- cerca di caricare librerie ed API dinamicamente, infatti nelle stringhe si trovano riferimenti ad API non importate staticamente
- cerca di interagire con la linea di comando, presumibilmente per inviare comandi shell

Inoltre è evidente che il malware adotti diverse tecniche di anti-debugging:
- si notano API per la gestione dei TLS, quindi magari delle tls-callbacks
- sono importate API classiche per anti-debugging, come l'uso di `IsDebuggerPresent`, che esplicitamente cerca per un debugger; oppure `GetTickCount` che potrebbe essere usata per contare quanto tempo scorre tra l'esecuzione dei comandi
- potrebbero essere utili come anti-debug anche le API di sincronizzazione ma *da capire*

**NON** sembrano presente API (e nemmeno stringhe) che fanno riferimento ai Windows Registries.

## Quali stringhe sono contenute nel malware?

`WinHttpWriteDataWinHttpQueryHeadWinHttpCloseHandWinHttpReceiveReWinHttpOpenRequeWinHttpQueryOptiWinHttpSetOptionWinHttpAddReques\`
Tale stringa sembra essere una raccolta di API non importate staticamente, appartenenti a `WinHTTP`, potrebbe essere che, runtime, questa stringa venga separata ed alcuni di questi metodi utilizzati.

Tra le stringhe si nota:
- riferimenti ad uno user-agent: `Mozilla/5.0 (Windows NT 6.1; Win64; rv:46.0)`
- riferimenti a MIME
	- `------Boundary%08X\r\nContent-Disposition: form-data; name="file"; filename="%ls"\r\nContent-Type: application/octet-stream\r\n\r\n`
- alfabeti utili per una eventuale codifica
- API e metodi utili per HTTP, e.g. `POST`, `GET`
Questo potrebbe ricondursi al fatto che **il malware tenti una data exfiltration oppure tenti di scaricare un file** verso/da un server HTTP (di cui ancora non capisco l'URL) codificando/decodificando i dati in base64 (infatti è specificato `octet-stream`).

Inoltre si individuano due stringhe che fanno chiaro riferimento a dei comandi shell:
- `cmd.exe /C ping 3.5.6.6 -n 4` - comando che invoca il `ping` verso `3.5.6.6` quattro volte
- `%ls -w 3180 & rmdir /Q /S "%ls"` - (qua sembra che `%ls` sia un placeholder che viene utilizzato anche nei riferimenti a MIME)
	- `%ls` - in C/C++ si riferisce ad una stringa unicode, che potrebbe essere il filename di un file utilizzato dal malware e probabilmente trasferito ad un server HTTP
	- `-w 3180` - potrebbe essere una opzione e quindi `%ls` potrebbe essere un eseguibile
	- `rmdir /Q /S "%ls"`
		- `rmdir` è il comando di Windows per rimuovere directory.
		- `/Q` è l'opzione "quiet" che sopprime le conferme.
		- `/S` è l'opzione che rimuove tutte le sottodirectory e i file nella directory specificata.
		- `"%ls"` è di nuovo un placeholder che verrà sostituito con un nome di directory 

**Forse più probabile che il file `%ls` venga scaricato, eseguito ed infine cancellato dal malware.**

==Da capire se `%ls` indica una cartella o un file eseguibile!==

### Ci sono stringhe che potrebbero corrispondere a file o a cartelle?
Ci sono diverse stringhe che fanno riferimento ad API di gestione di files, ma nulla che identifichi un vero e proprio file o cartella.

Una stringa interessante è `mscoree.dll` che non è indicata tra gli imports. Tale libreria potrebbe essere caricata runtime per integrare funzionalità legittime di Windows.

### Ci sono stringhe che potrebbero corrispondere a sotto-chiavi del Windows registry?
Non sembrano essere presenti stringhe facenti riferimento a Windows Registries.

### Ci sono stringhe che potrebbero corrispondere ad URL o indirizzi IP?
In una stringa è specificato un indirizzo IP: `3.5.6.6`. Inoltre sono presenti alcune mail con dominio: `contact@digestsecurity.com1`

Riferimenti espliciti ad URLs non sembrano essere presenti.

## Alcune stringhe sono offuscate o cifrate?
Sono presenti diversi alfabeti ma per ora si suppone che vengano usati per la codifica/decodifica base64 dei dati inviati o ricevuti tramite HTTP.

### Quale codifica o algoritmo di cifratura viene utilizzato?
Per ora sembra solo base64 (c'è `octet-stream`) ma ci sono stringhe strane un po' ovunque.

---

# Analisi dinamica di base

## Il malware crea o modifica chiavi o sottochiavi del Windows registry?


## Il malware crea o cancella cartelle o file sulla macchina?


## Il malware crea qualche altro processo?


## Il malware è persistente sulla macchina virtuale?

### Quale tecnica usa?

---

# Analisi del traffico di rete

## Il malware inizia connessioni di rete?
Il malware inizializza connessioni di rete, l'indirizzo più sospetto è `apn-state-upd2.com` che non viene rilevato durante l'analisi statica.
### Che tipo di traffico genera e verso quali URL o IP?
Il traffico generato utilizza il protocollo TLSv1.2 ed invia dati criptati attraverso molteplici sessioni TLS.

Il report di `inetsim` ci riporta delle informazioni aggiuntive riguardo le probabile richieste del malware.

Circa ogni 12 secondi da un certo momento invia una coppia di richieste:
1. `method: POST, URL: https://apn-state-upd2.com/p5Pss34GvX21pxO0bz25vLqU.php`
2. `method: POST, URL: https://apn-state-upd2.com/p5Pss34GvX21pxO0bz25vLqU.php`

Il file che `inetsim` gli associa riportano queste informazioni:
1. `name=v11_kt5p0_3834129251`
2. `name=v11_kt5p0_3834129251&delete=ok

`name` potrebbe riferirsi ad un nome di file che viene generato/creato dal malware.

Tra l'altro ci sono richieste DNS per capire l'IP di `apn-state-upd2.com`.


---

# Reverse engineering della funzione `sub_4020BE`

