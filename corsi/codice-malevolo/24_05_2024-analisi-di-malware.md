Oggi si analizza il file `Chapter16L/Lab16-02`

Si nota immediatamente con pestudio che è presente una tls-callback (nota tecnica di anti-debugging -> ref. [[22_05_2024-anti-analysis-analysis]])

Apriamo IDA per capire cosa fa la tls callback implementata.

Tale tecnica cerca di capire se è presente, in quel momento, una finestra che corrisponde al nome di "OLLYDBG", ovvero un noto debugger.
Si nota che viene usata l'API `FindWindowA` che permette, appunto di fare ciò.

Ora si analizza il main:
- controlla che in input sia stata inserita una password
- la password è generata da un thread (a cui viene passata la funzione di modifica)
- probabilmente la pwd è decodificata secondo una determinata logica
- in mezzo a stodegheio viene salvato l'indirizzo del PEB
- e viene puntata la flag: `BeingDebugged`

Inoltre il thread utilizza un altro valore: `byte_40A968`.

Grazie alle cross-references (tasto `X`) si scopre che tale valore è stato inizializzato in: `sub_401020`.

Scopriamo, così, un'altra tecnica di debug:
- `OutputDebugStringA` -> invia una stringa al debugger che deve essere visualizzata

Il malware invia `'b'` al debugger e controlla l'errore di uscita con uno pre-impostato, se i due errori sono uguali allora il malware scopre di essere eseguito attraverso un debugger.

Un modo per bypassare questo controllo sarebbe quello di patchare il file durante per evitare di impostare il byte di controllo a 1.

La funzione di callback viene richiamata due volte:
1. inizio del programma
2. alla creazione del thread (perché è specificato il valore 2)

