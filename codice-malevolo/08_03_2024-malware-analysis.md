La prima cosa che si fa quando si parla di malware analysis è quella di cercare di classificare il malware secondo le diverse categorie descritte.
Inoltre è necessario raccogliere una serie di indicazione per rilevare le infezioni causate dal malware.

Tipicamente quando un malware infetta un sistema esso va a creare file aggiuntivi che possono dare indicazioni sulla natura del software malevolo (e.g.: chiavi di persistenza, configurazioni, cartelle, ecc...).

Altro procedimento tipico è quello di fare ricerca sul rapporto tra possibili motivazioni e comportamento del malware.

Successivamente si analizzano anche le tecniche di attacco per cercare di ricollegarle ad uno specifico gruppo di cyber-criminali.

Nello specifico si segue un processo ciclico tra:
- analisi statica, analisi preliminare
- analisi dinamica, analisi più dettagliata

Abbiamo 4 tipologie:
- **Basic static analysis** - estrazioni info dal file binario per cercare di capire il comportamento (è abbastanza limitata ma ci permette di ottenere una prima ipotesi). Bisogna capire il formato del binario e le funzioni importate dal malware (ambiente Win)
- **Basic dynamic analysis** - analisi del funzionamento del malware su una VM isolata
- **Advanced static analysis** - si utilizza un disassembler per tradurre il linguaggio macchina in linguaggio ad alto livello (x86-32bit nel corso) per cercare di semplificare l'analisi del comportamento
- **Advanced dynamic analysis** - si utilizza un debugger per eseguire il malware in maniera controllata

Necessitiamo di VM per le varie analisi perché:
- permettono di isolarle dalla rete
- permettono di creare gli snapshot per ripristinare lo stato della macchina

Remnux VM è una macchina creata da uno dei più grandi malware analyst che mette a disposizione diversi tool per svolgere le analisi.

## Windows API
Le WinAPI mettono a disposizione diversi costrutti:
- WORD
- DWORD
- Handle - corrispondono ai puntatori e permettono di fare riferimento ad oggetti del SO
- Long Pointer (LP) - permettono di puntare ad altri tipologie di dati (e.g. PBYTE, LPSTRG)

Una delle API trovabili è la `CreateWindowsEx` che ritorna un Handle alla finestra.

Esistono una serie di chiamate che permettono di gestire i file del sistema operativo:
- `CreateFile`
- `ReadFile`
- `WriteFile`
- `CreateFileMapping` - prende un file salvato sulla macchina infetta e lo carica in memoria
- `MapViewOfFile` - restituisce un Handle all'area della memoria in cui è stato precedentemente caricato il file, l'Handle permetterà di modificare quella sezione

### Registri di Windows
I registri della macchina possono essere utili per svariate motivazione:
- raggiungere la persistenza
- modifica di applicazioni utili (e.g. WinDefender)

I registri seguono una gerarchia:
- root keys - sono le chiavi principali (e.g. HKCU - current user)
	- keys - coppie nome valore che mantengono info utili al sistema
		- sub-keys - catturano informazioni relative alla gerarchia

Possono essere usati diversi registri per acquisire persistenza (slidozze diddio).

`Autoruns` è un tool che permette di controllare tutte le location del SO (e.g. cartelle, registri, ecc) dove il malware avrebbe potuto ottenere persistenza.

API per modificare i registri:
- `RegOpenKeyEx` - apertura che restituisce l'Handle
- `RegSetValueEx` - aggiunge valore al registro
- `RegSetValue` - recupero del valore del registro

## Networking API
Ci sono due tipologie di API:
- `ws2_32.dll` - implementa diverse funzionalità
	- la chiamata alle socket iniziale usa `wsstartup`
	- Un malware o svolge il compito di server oppure di client, in base al ruolo svolgerà chiamate diverse alle Network API
- `WinINet API` - libreria ad alto livello che sfrutta i protocolli applicativi (e.g. HTTP)

## Esecuzione del codice
Tipicamente per implementare le funzionalità dei programmi Windows un malware deve importare delle librerie `dll`.
La `dll` non può essere eseguita da solo, quando il prog viene caricato in RAM allora le `dll` vengono allocate a loro volta.
Quando una funzione delle `dll` viene chiamata dal programma prima chiama una `dllMain`.

I malware usano le `dll` per implementare le loro funzionalità, inoltre le usano per utilizzare codice in maniera malevola.
Spesso il codice malevolo è contenuto in `dll` che viene caricato ed eseguito.

Inoltre le dll possono essere usate per raggiungere persistenza, esse sfruttano il modo in cui il loader del SO carica le librerie, esso cerca in ordine:
- directory del programma
- windows/system32
- windows/system
- windows
- current dir
- %PATH%
Quindi può essere utile caricare una `dll` con stesso nome nella dir del programma.

Tipicamente un malware potrebbe scaricare un altro eseguibile malevolo e poi potrebbe utilizzare le API per la gestione dei processi per eseguirlo:
- `CreateProcess` - crea un processo, possibile uso: remote shell! Per farlo creano una socket, recuperano l'Handle e lo passano come valore di stdin e stdout.
Altra modalità è quella di sfruttare i Thread del processo (condividono lo spazio di memoria):
- si possono eseguire `dll` malevole attraverso la creazione di un thread, se il thread non viene creato nello stesso spazio di memoria viene bypassato il sistema
Ulteriore possibilità è quella di creare dei servizi, essi vengono eseguiti in background. Esistono 3 API (slidess).
Tipicamente usano 2 servizi:
- SHARE_PROCESS - vengono eseguiti da un processo che raggruppa più servizi (svchost carica in memoria una `dll` e la esegue)
- OWN_PROCESS - avvia un eseguibile come processo indipendente (tali info sono contenute in uno specifico registro rappresentato nelle slidone potenti)

## Basic Static Analysis
Si cerca di rispondere a delle semplici domande fornite dai lucidoni sgravati.

### Identificazione del file
Determinazione del tipo di file analizzando estensioni e proprietà del file stesso. Inoltre interessa capire se il file è impacchettato in un certo modo (e.g. UPX tool).

Tipicamente si va ad analizzare la **signature**, ovvero un'informazione che permette di individuare la natura del file (e.g. comando `file` oppure `strings` per visualizzare le stringhe statiche contenute).

Inoltre è possibile condividere l'hash del malware per capire eventuale modifiche. Di solito si usa SHA256.

Un file impacchettato non mostra le stringhe statiche contenute e quindi è possibile celare tale sezione. Inoltre è possibile aggiungere stringhe per cercare di rendere, APPARENTEMENTE, il file benevolo.
